#!/bin/bash
set -e
WORKDIR=/go/src/github.com/armory-io/dinghy

mkdir -p ${HOME}/.armory/cache
aws s3 cp s3://armory-keys/client.pem ${HOME}/.armory/cache/client.pem

docker run --rm \
  -v "$PWD:$WORKDIR" \
  -w $WORKDIR \
  -e "GOOS=linux" \
  -e "GOARCH=amd64" \
  -e "CGO_ENABLED=0" \
  -e "ORCA_BASE_URL=http://spinnaker.dev.armory.io:8083" \
  -e "FRONT50_BASE_URL=http://spinnaker.dev.armory.io:8080" \
  andrexus/golang-dep \
  make integration

echo "Docker image is ${DOCKER_IMAGE}."
docker run --rm \
  -v "$PWD:$WORKDIR" \
  -v "${HOME}/.armory/cache/:/creds/" \
  -w $WORKDIR \
  --entrypoint $WORKDIR/bin/test_runner_harness \
  "$DOCKER_IMAGE"

