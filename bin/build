#!/bin/bash -x
set -e
cd "$(dirname "$0")/.."

echo "Building binary first..."
GIT_HASH=$(git rev-parse HEAD | cut -c -7)
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
DOCKER_REGISTRY=gcr.io/cloud-armory
export DOCKER_IMAGE=${DOCKER_REGISTRY}/${GIT_REPO}:${GIT_HASH}

WORKDIR=/go/src/github.com/armory-io/${GIT_REPO}

#this just builds the binary in a container first
docker run --rm \
  -v "$PWD:$WORKDIR" \
  -w $WORKDIR \
  -e "GOOS=linux" \
  -e "GOARCH=amd64" \
  -e "CGO_ENABLED=0" \
  andrexus/golang-dep \
  make

echo "Building docker image $DOCKER_IMAGE..."
docker build -t "$DOCKER_IMAGE" .
