#!/bin/bash -x
set -e
cd "$(dirname "$0")/.."
source bin/env
echo "Building binary first..."
WORKDIR=/go/src/github.com/armory-io/${GIT_REPO}

#this just builds the binary in a container first
docker run --rm \
  -v "$PWD:$WORKDIR" \
  -w $WORKDIR \
  -e "GOOS=linux" \
  -e "GOARCH=amd64" \
  -e "CGO_ENABLED=0" \
  andrexus/golang-dep \
  make

echo "Building docker image ${DOCKER_IMAGE}..."
docker build -t "${DOCKER_IMAGE}" .
docker tag ${DOCKER_IMAGE} ${HALYARD_DOCKER_IMAGE}
